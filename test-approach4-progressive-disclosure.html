<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Approach 4: Progressive Disclosure Design</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Progressive Popup System */
        .mapboxgl-popup-content {
            padding: 0;
            width: 300px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        /* Level 1: Icon indicators */
        .icon-indicator {
            position: absolute;
            background: white;
            border-radius: 20px;
            padding: 4px 8px;
            font-size: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            pointer-events: none;
        }
        
        /* Level 2: Hover card */
        .hover-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            max-width: 250px;
        }
        .hover-card-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .hover-card-subtitle {
            font-size: 12px;
            color: #64748b;
        }
        .hover-card-hint {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
            font-style: italic;
        }
        
        /* Level 3: Expandable popup */
        .popup-stage {
            transition: all 0.3s ease;
        }
        
        .popup-header {
            padding: 15px;
            cursor: pointer;
            user-select: none;
        }
        .popup-header-private {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }
        .popup-header-public {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        .popup-header-title {
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .expand-icon {
            transition: transform 0.3s;
            font-size: 20px;
        }
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        /* Stage 1: Essential info */
        .stage-essential {
            padding: 15px;
            background: #f8fafc;
        }
        .essential-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .essential-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        
        /* Stage 2: Important details */
        .stage-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
        }
        .stage-details.expanded {
            max-height: 300px;
        }
        .details-content {
            padding: 15px;
        }
        .detail-section {
            margin-bottom: 12px;
        }
        .detail-title {
            font-weight: 500;
            font-size: 13px;
            color: #475569;
            margin-bottom: 4px;
        }
        .detail-text {
            font-size: 13px;
            color: #64748b;
        }
        
        /* Stage 3: Full information */
        .stage-full {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #f1f5f9;
        }
        .stage-full.expanded {
            max-height: 200px;
            overflow-y: auto;
        }
        .full-content {
            padding: 15px;
            font-size: 12px;
            color: #64748b;
        }
        
        /* Action buttons */
        .popup-actions {
            padding: 12px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
        }
        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #475569;
        }
        .action-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .action-btn-primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .action-btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }
        
        /* Onboarding tooltip */
        .onboarding-tooltip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1e293b;
            color: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 300px;
            text-align: center;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        .onboarding-dismiss {
            margin-top: 15px;
            padding: 8px 16px;
            background: white;
            color: #1e293b;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* Visual feedback */
        .zone-glow {
            animation: glow 2s ease-in-out infinite;
        }
        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.8)); }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Onboarding -->
    <div class="onboarding-tooltip" id="onboarding">
        <h3 style="margin: 0 0 10px 0;">Progressive Information</h3>
        <p style="margin: 0 0 15px 0; font-size: 14px;">
            Hover for quick info → Click for essentials → Expand for full details
        </p>
        <button class="onboarding-dismiss" onclick="dismissOnboarding()">Got it!</button>
    </div>

    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYm9iZXJzIiwiYSI6ImNtNDZ6Y3RuZzA5NmUyanB0aHlndWt0YnQifQ.0NqAw9QvIMAGpZL2PKtQJg';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [13.405, 52.52],
        zoom: 11
    });
    
    let currentPopup = null;
    let currentHover = null;
    let popupStage = 1;
    
    // Data
    const privateZones = {
        type: 'FeatureCollection',
        features: [
            {
                type: 'Feature',
                geometry: {
                    type: 'Polygon',
                    coordinates: [[
                        [13.38, 52.50],
                        [13.40, 52.50],
                        [13.40, 52.52],
                        [13.38, 52.52],
                        [13.38, 52.50]
                    ]]
                },
                properties: {
                    type: 'private',
                    name: 'Mitte Residential Zone',
                    hoverInfo: 'Electric grills only zone',
                    essential: {
                        equipment: 'Electric BBQ only',
                        frequency: 'Max 2x/month',
                        hours: '10:00 - 22:00'
                    },
                    details: {
                        rules: 'Check lease agreement, notify neighbors, use courtyards only',
                        fines: '€50 - €500 for violations',
                        enforcement: 'Building management & Ordnungsamt'
                    },
                    full: {
                        legal: 'According to Berlin Mietrecht §123...',
                        tips: 'Best days are weekends, avoid holidays',
                        contact: 'District office: 030-90123-456'
                    }
                }
            }
        ]
    };
    
    const publicSpots = {
        type: 'FeatureCollection',
        features: [
            {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [13.412, 52.526]
                },
                properties: {
                    name: 'Mauerpark Grillplatz',
                    type: 'public',
                    hoverInfo: 'Public BBQ area - All equipment OK',
                    essential: {
                        equipment: 'All grill types allowed',
                        capacity: '50 groups',
                        hours: '10:00 - 22:00'
                    },
                    details: {
                        facilities: 'Water, toilets, waste disposal',
                        rules: 'First come first served, clean up required',
                        restrictions: 'No grilling during fire warnings'
                    },
                    full: {
                        transport: 'U8 Bernauer Str., Tram M10',
                        parking: 'Limited street parking',
                        history: 'Established as grill zone in 2015'
                    }
                }
            }
        ]
    };
    
    map.on('load', () => {
        // Add sources
        map.addSource('private-zones', {
            type: 'geojson',
            data: privateZones
        });
        
        map.addSource('public-spots', {
            type: 'geojson',
            data: publicSpots
        });
        
        // Layers
        map.addLayer({
            id: 'private-zones-fill',
            type: 'fill',
            source: 'private-zones',
            paint: {
                'fill-color': '#fbbf24',
                'fill-opacity': 0.25
            }
        });
        
        map.addLayer({
            id: 'private-zones-outline',
            type: 'line',
            source: 'private-zones',
            paint: {
                'line-color': '#f59e0b',
                'line-width': 2,
                'line-dasharray': [2, 2]
            }
        });
        
        map.addLayer({
            id: 'public-spots',
            type: 'circle',
            source: 'public-spots',
            paint: {
                'circle-radius': 15,
                'circle-color': '#22c55e',
                'circle-stroke-color': '#16a34a',
                'circle-stroke-width': 3
            }
        });
        
        // Add icon indicators
        map.addLayer({
            id: 'zone-icons',
            type: 'symbol',
            source: 'private-zones',
            layout: {
                'text-field': '⚡',
                'text-size': 24,
                'text-anchor': 'center'
            }
        });
        
        map.addLayer({
            id: 'spot-icons',
            type: 'symbol',
            source: 'public-spots',
            layout: {
                'text-field': '🔥',
                'text-size': 24,
                'text-anchor': 'center'
            }
        });
        
        // Hover interactions
        map.on('mouseenter', 'private-zones-fill', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            if (!currentHover) {
                const props = e.features[0].properties;
                currentHover = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false,
                    offset: 25
                })
                .setLngLat(e.lngLat)
                .setHTML(`
                    <div class="hover-card">
                        <div class="hover-card-title">${props.name}</div>
                        <div class="hover-card-subtitle">${props.hoverInfo}</div>
                        <div class="hover-card-hint">Click for more info...</div>
                    </div>
                `)
                .addTo(map);
            }
        });
        
        map.on('mouseleave', 'private-zones-fill', () => {
            map.getCanvas().style.cursor = '';
            if (currentHover) {
                currentHover.remove();
                currentHover = null;
            }
        });
        
        // Click interactions
        map.on('click', 'private-zones-fill', (e) => {
            if (currentHover) {
                currentHover.remove();
                currentHover = null;
            }
            showProgressivePopup(e.features[0].properties, e.lngLat, 'private');
        });
        
        map.on('click', 'public-spots', (e) => {
            showProgressivePopup(e.features[0].properties, e.features[0].geometry.coordinates, 'public');
        });
        
        // Public spots hover
        map.on('mouseenter', 'public-spots', () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'public-spots', () => {
            map.getCanvas().style.cursor = '';
        });
    });
    
    function showProgressivePopup(props, coords, type) {
        if (currentPopup) currentPopup.remove();
        
        popupStage = 1;
        const popupHTML = `
            <div class="popup-stage">
                <div class="popup-header popup-header-${type}" onclick="toggleStage()">
                    <div class="popup-header-title">
                        <span>${props.name}</span>
                        <span class="expand-icon" id="expandIcon">▼</span>
                    </div>
                </div>
                
                <div class="stage-essential">
                    <div class="essential-item">
                        <span class="essential-icon">🔧</span>
                        <span>${props.essential.equipment}</span>
                    </div>
                    <div class="essential-item">
                        <span class="essential-icon">📅</span>
                        <span>${props.essential.frequency || props.essential.capacity}</span>
                    </div>
                    <div class="essential-item">
                        <span class="essential-icon">🕐</span>
                        <span>${props.essential.hours}</span>
                    </div>
                </div>
                
                <div class="stage-details" id="stageDetails">
                    <div class="details-content">
                        ${Object.entries(props.details).map(([key, value]) => `
                            <div class="detail-section">
                                <div class="detail-title">${key.charAt(0).toUpperCase() + key.slice(1)}:</div>
                                <div class="detail-text">${value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="stage-full" id="stageFull">
                    <div class="full-content">
                        ${Object.entries(props.full).map(([key, value]) => `
                            <p><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}</p>
                        `).join('')}
                    </div>
                </div>
                
                <div class="popup-actions">
                    <button class="action-btn" onclick="shareLocation()">📤 Share</button>
                    <button class="action-btn action-btn-primary" onclick="getDirections(${coords})">
                        📍 Directions
                    </button>
                </div>
            </div>
        `;
        
        currentPopup = new mapboxgl.Popup({
            maxWidth: '300px',
            className: 'progressive-popup'
        })
        .setLngLat(coords)
        .setHTML(popupHTML)
        .addTo(map);
    }
    
    function toggleStage() {
        const details = document.getElementById('stageDetails');
        const full = document.getElementById('stageFull');
        const icon = document.getElementById('expandIcon');
        
        if (popupStage === 1) {
            details.classList.add('expanded');
            icon.classList.add('expanded');
            popupStage = 2;
        } else if (popupStage === 2) {
            full.classList.add('expanded');
            popupStage = 3;
        } else {
            details.classList.remove('expanded');
            full.classList.remove('expanded');
            icon.classList.remove('expanded');
            popupStage = 1;
        }
    }
    
    function shareLocation() {
        alert('Location copied to clipboard!');
    }
    
    function getDirections(coords) {
        const lat = Array.isArray(coords) ? coords[1] : coords.lat;
        const lng = Array.isArray(coords) ? coords[0] : coords.lng;
        window.open(`https://maps.google.com/?q=${lat},${lng}`, '_blank');
    }
    
    function dismissOnboarding() {
        document.getElementById('onboarding').style.display = 'none';
        // Add initial glow effect to zones
        map.setPaintProperty('private-zones-fill', 'fill-opacity', 0.4);
        setTimeout(() => {
            map.setPaintProperty('private-zones-fill', 'fill-opacity', 0.25);
        }, 2000);
    }
    
    // Auto-dismiss onboarding after 5 seconds
    setTimeout(dismissOnboarding, 5000);
    </script>
</body>
</html>